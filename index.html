<!DOCTYPE html>
<html>
<head>
    <title>ç²—å¤§ã‚´ãƒŸä¾¡æ ¼åˆ¤åˆ¥ã‚¢ãƒ—ãƒª - èƒŒé¢ã‚«ãƒ¡ãƒ©å¯¾å¿œ</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 20px; }
        #webcam-container, #image-container { 
            margin: 20px auto; 
            border: 1px solid #ccc; 
            display: none; 
            max-width: 300px; 
            max-height: 300px;
            overflow: hidden; 
        }
        video, img { width: 100%; height: auto; }
        #controls button, input[type="file"] { margin: 10px; padding: 10px 20px; font-size: 16px; }
        #price-output { font-size: 3em; color: red; font-weight: bold; margin-top: 20px; }
        #confidence-output { font-size: 1.2em; color: gray; margin-top: 5px; }
        .active-display { display: inline-block !important; } 
    </style>
</head>
<body>
    <h1>ç²—å¤§ã‚´ãƒŸä¾¡æ ¼åˆ¤åˆ¥</h1>

    <div id="controls">
        <button id="startWebcamBtn">ã‚«ãƒ¡ãƒ©ã§åˆ¤åˆ¥</button>
        <input type="file" id="uploadImage" accept="image/*">
    </div>

    <div id="webcam-container"></div>
    <div id="image-container">
        <img id="uploadedImageDisplay" src="" alt="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒ" style="display: none;">
    </div>

    <h3>äºˆæƒ³ã•ã‚Œã‚‹å‡¦åˆ†è²»ç”¨:</h3>
    <div id="price-output">---</div>
    <div id="confidence-output"></div>

    <!-- TensorFlow.js ã¨ Teachable Machine -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

    <script type="text/javascript">
        const URL = "./model/";

        let model, maxPredictions;
        let currentDisplayMode = 'webcam';
        let videoStream;
        let isPredicting = false;

        // DOMè¦ç´ å–å¾—
        const webcamContainer = document.getElementById('webcam-container');
        const imageContainer = document.getElementById('image-container');
        const uploadedImageDisplay = document.getElementById('uploadedImageDisplay');
        const priceElement = document.getElementById('price-output');
        const confidenceElement = document.getElementById('confidence-output');
        const startWebcamBtn = document.getElementById('startWebcamBtn');
        const uploadImageInput = document.getElementById('uploadImage');

        // âœ… ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ï¼†èƒŒé¢ã‚«ãƒ¡ãƒ©èµ·å‹•
        async function init() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            await startWebcam(); // èƒŒé¢ã‚«ãƒ¡ãƒ©èµ·å‹•
        }

        // âœ… èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’å„ªå…ˆã—ã¦èµ·å‹•ã™ã‚‹é–¢æ•°
        async function startWebcam() {
            if (videoStream) {
                const tracks = videoStream.getTracks();
                tracks.forEach(track => track.stop());
            }

            const video = document.createElement("video");
            video.width = 300;
            video.height = 300;
            video.autoplay = true;
            video.playsInline = true;

            webcamContainer.innerHTML = "";
            webcamContainer.appendChild(video);
            webcamContainer.classList.add("active-display");
            imageContainer.classList.remove("active-display");
            uploadedImageDisplay.style.display = "none";

            try {
                // ğŸ¥ èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’å„ªå…ˆ
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: { exact: "environment" } },
                    audio: false
                });
                video.srcObject = videoStream;
                video.onloadeddata = () => {
                    currentDisplayMode = 'webcam';
                    loop(video);
                };
            } catch (err) {
                console.warn("èƒŒé¢ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚å‰é¢ã‚«ãƒ¡ãƒ©ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™:", err);
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "user" },
                    audio: false
                });
                video.srcObject = videoStream;
                video.onloadeddata = () => {
                    currentDisplayMode = 'webcam';
                    loop(video);
                };
            }

            priceElement.innerHTML = "---";
            confidenceElement.innerHTML = "";
        }

        // âœ… ã‚«ãƒ¡ãƒ©æ˜ åƒã‚’ç¶™ç¶šçš„ã«åˆ¤åˆ¥
        async function loop(video) {
            if (currentDisplayMode !== 'webcam') return;

            if (!isPredicting) {
                isPredicting = true;
                const prediction = await model.predict(video);
                updatePriceDisplay(prediction);
                isPredicting = false;
            }

            requestAnimationFrame(() => loop(video));
        }

        // âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒå‡¦ç†
        uploadImageInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (videoStream) {
                const tracks = videoStream.getTracks();
                tracks.forEach(track => track.stop());
            }

            webcamContainer.classList.remove('active-display');

            const reader = new FileReader();
            reader.onload = async (e) => {
                uploadedImageDisplay.src = e.target.result;
                uploadedImageDisplay.style.display = 'block';
                imageContainer.classList.add('active-display');
                currentDisplayMode = 'image';

                await predictFromImage(uploadedImageDisplay);
            };
            reader.readAsDataURL(file);
        });

        startWebcamBtn.addEventListener('click', startWebcam);

        // âœ… ç”»åƒã‹ã‚‰åˆ¤åˆ¥
        async function predictFromImage(imgElement) {
            const prediction = await model.predict(imgElement);
            updatePriceDisplay(prediction);
        }

        // âœ… åˆ¤åˆ¥çµæœã‚’è¡¨ç¤º
        function updatePriceDisplay(prediction) {
            let highestProb = 0;
            let predictedPrice = "---";
            let highestClassName = "";

            for (let i = 0; i < maxPredictions; i++) {
                if (prediction[i].probability > highestProb) {
                    highestProb = prediction[i].probability;
                    predictedPrice = prediction[i].className;
                    highestClassName = prediction[i].className;
                }
            }

            const confidencePercentage = (highestProb * 100).toFixed(1);

            if (highestProb > 0.7) {
                priceElement.innerHTML = `${predictedPrice}`;
                confidenceElement.innerHTML = `(ç¢ºä¿¡åº¦: ${confidencePercentage}%)`;
            } else {
                priceElement.innerHTML = "åˆ¤åˆ¥ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
                confidenceElement.innerHTML = `(æœ€ã‚‚è¿‘ã„çµæœ: ${highestClassName} - ${confidencePercentage}%)`;
            }
        }

        window.onload = init;
    </script>
</body>
</html>